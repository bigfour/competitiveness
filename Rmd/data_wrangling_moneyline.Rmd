---
title: "Moneyline Data Wrangling Part II"
author: "Greg Matthews & Mike Lopez"
date: "June 24, 2016"
output: html_document
---

```{r, message=FALSE}
require(dplyr)
mlb <- read.csv("~/Dropbox/competitiveness/Data/MLB-Data_moneyline.csv", stringsAsFactors = FALSE)
nba <- read.csv("~/Dropbox/competitiveness/Data/NBA-Data_moneyline.csv", stringsAsFactors = FALSE)
nfl <- read.csv("~/Dropbox/competitiveness/Data/NFL-Data_moneyline.csv", stringsAsFactors = FALSE)
nhl <- read.csv("~/Dropbox/competitiveness/Data/NHL-Data_moneyline.csv", stringsAsFactors = FALSE)
```

Clean up the NHL data

```{r}
nhl <- nhl %>% filter(visitor_team != '')
```

Combine them

```{r, message=FALSE}
ds <- bind_rows(mlb, nba, nfl, nhl)
ds <- mutate(ds, sport = c(rep("mlb", nrow(mlb)), rep("nba", nrow(nba)), rep("nfl", nrow(nfl)), rep("nhl", nrow(nhl))))
```

Remove any duplicate lines

```{r}
ds <- unique(ds)
```

Clean up dates

```{r, message=FALSE}
require(lubridate)
ds <- ds %>%
  mutate(gameDate = mdy_hm(event_date), gameTime = mdy_hm(event_datetime)) %>%
# discard games with no times? For now???
  filter(!is.na(gameTime))
```

Make the columns easier to use

```{r}
ds <- ds %>%
  rename(ml_vis = Money.Line.Visitor) %>%
  rename(ml_home = Money.Line.Home)
```

Define the seasons

```{r}
# start with just using the year
ds <- ds %>%
  mutate(season = year(gameDate))
# but for NBA and NHL, have to adjust
ds <- ds %>%
  mutate(season = ifelse(sport %in% c("nba", "nhl") & month(gameDate) > 7, 
                year(gameDate) + 1, season))
# NFL too
ds <- ds %>%
  mutate(season = ifelse(sport == "nfl" & month(gameDate) < 4, 
                season - 1, season))
```

Strip out all games where we don't have the line

```{r}
ds <- filter(ds, !is.na(ml_home))
```

Find all the real teams

```{r}
teams <- ds %>%
  group_by(home_team) %>%
  summarise(N = n()) %>%
  filter(N > 100) %>%
  # is there some kind of weird hockey betting?
  filter(home_team != "Home Goals") %>%
  arrange(desc(N))
```

Restrict to only to those teams

```{r}
ds <- semi_join(ds, teams, by = c("home_team"))
```


Remove multiple lines for each game

```{r}
games <- ds %>%
  group_by(home_team, gameTime) %>%
  summarise(min_visitor_nss = min(visitor_nss))
ds <- semi_join(ds, games, by = c("home_team", "gameTime", "visitor_nss" = "min_visitor_nss"))
ds <- filter(ds, visitor_nss < 1000)
```

Still have multiple lines for some NHL games!

```{r}
dupes <- ds %>%
  group_by(home_team, gameTime) %>%
  summarise(N = n()) %>%
  filter(N > 1)
dupes
```

Arbitrarily remove one of them

```{r}
dup.idx <- ds %>%
  semi_join(dupes, by = c("gameTime", "home_team"))
# just take the later ones
dup.bad <- dup.idx[rep(c(TRUE, FALSE), nrow(dup.idx) / 2),]
ds <- ds %>%
  anti_join(dup.bad, by = c("gameTime", "home_team"))
```


What to do about doubleheaders? 

```{r}
filter(ds, sport == "mlb" & season == 2013 & home_team == "Colorado Rockies" & month(gameDate) == 4 & day(gameDate) == 16) %>% print.data.frame()
dh <- ds %>%
  group_by(gameDate, home_team) %>%
  summarise(numGames = n()) %>%
  filter(numGames > 1)
dh.idx <- dh %>%
  semi_join(x = ds, by = c("gameDate", "home_team")) %>%
  mutate(dh = rep(c(1,2), nrow(dh)))

ds <- ds %>%
  left_join(select(dh.idx, gameTime, home_team, dh), by = c("gameTime", "home_team"))

# no tripleheaders
ds <- filter(ds, is.na(dh) == TRUE | dh < 2)

ds %>%
  group_by(gameDate, home_team) %>%
  summarise(numGames = n()) %>%
  filter(numGames > 2)
```

Identify preseason and postseason games

```{r}
ds <- ds %>%
  # these could be more specific
  filter(!(sport == "mlb" & month(gameDate) < 4)) %>%
  filter(!(sport == "nba" & month(gameDate) < 10 & month(gameDate) > 6)) %>%
  filter(!(sport == "nfl" & month(gameDate) > 2 & month(gameDate) < 9)) %>%
  filter(!(sport == "nhl" & month(gameDate) < 9 & month(gameDate) > 6))
```

```{r}
test <- filter(ds, sport == "mlb" & season == 2011)

ds %>%
  group_by(sport, season) %>%
  summarise(N = n(), numTeams = length(unique(union(visitor_team, home_team)))) %>%
  print.data.frame()
```


Compute implied probabilities

```{r}
ds <- ds %>%
  mutate(prob_vis = ifelse(ml_vis > 0, 100 / (100 + ml_vis), abs(ml_vis) / (100 + abs(ml_vis)))) %>%
  mutate(prob_home = ifelse(ml_home > 0, 100 / (100 + ml_home), abs(ml_home) / (100 + abs(ml_home)))) %>%
  mutate(vig = (prob_vis + prob_home) - 1) %>%
  mutate(p_vis = prob_vis / (prob_vis + prob_home)) %>%
  mutate(p_home = prob_home / (prob_vis + prob_home))
```

# double-check for bad data

```{r}
test <- filter(ds, ml_vis > 0 & p_vis > 0.5)
test
test$ml_vis

test <- filter(ds, vig > 0.1)
test
test$ml_vis
test$ml_home

```

Get rid of these problematic money lines 

```{r}
ds <- filter(ds, !ml_vis==56, !ml_home ==65)
```


Save the resulting data frame

```{r, eval=FALSE}
mline <- ds
save(mline, file = "~/Dropbox/competitiveness/Data/mlineGM.rda", compress = "xz")
```


```{r}
load("~/Dropbox/competitiveness/Data/mlineGM.rda")
mlb_results <- read.csv("~/Dropbox/competitiveness/Data/MLB_results.csv")
require(stringr)
mlb_res <- mlb_results %>%
  filter(Rk != "Rk") %>%
  # remove all the "road games"
  filter(X. != "@") %>%
  # capture doubleheaders
  mutate(dh = str_extract(str_extract(Date, "\\(.\\)"), "[0-9]+")) %>%
  mutate(dateString = paste(gsub("\\(.\\)", "", Date), year, sep = ",")) %>%
  mutate(gameDate = parse_date_time(dateString, orders = c("%b %d,%y"))) %>%
  mutate(home_team = Tm) %>%
  mutate(home_win = ifelse(as.numeric(R) > as.numeric(RA), TRUE, FALSE)) %>%
  select(gameDate, dh, home_team, home_win)
mlb_res %>%
  group_by(year(gameDate)) %>%
  summarise(N = n(), numTeams = length(unique(home_team)), home_p = sum(home_win) / n()) %>%
  print.data.frame()
```

Errors in Lahman package

```{r}
require(dplyr)
require(Lahman)
Teams %>%
  filter(teamID %in% c("CHA", "CHN") & yearID > 2010) %>%
  select(yearID, teamID, name)
```

```{r}
teamname_lkup <- Teams %>%
  filter(yearID >= min(year(mlb_res$gameDate))) %>%
  select(teamID, name) %>%
  unique()
# remove erroneous team pairs
teamname_lkup <- teamname_lkup[1:34,]
teamname_lkup <- bind_rows(teamname_lkup, data.frame(teamID = "TBD", name = "Tampa Bay Rays"))
teamname_lkup <- teamname_lkup %>%
  mutate(teamID = ifelse(teamID == "CHA", "CHW", as.character(teamID))) %>%
  mutate(teamID = ifelse(teamID == "NYA", "NYY", teamID)) %>%
  mutate(teamID = ifelse(teamID == "SLN", "STL", teamID)) %>%
  mutate(teamID = ifelse(teamID == "KCA", "KCR", teamID)) %>%
  mutate(teamID = ifelse(teamID == "CHN", "CHC", teamID)) %>%
  mutate(teamID = ifelse(teamID == "NYN", "NYM", teamID)) %>%
  mutate(teamID = ifelse(teamID == "FLO", "FLA", teamID)) %>%
  mutate(teamID = ifelse(teamID == "SFN", "SFG", teamID)) %>%
  mutate(teamID = ifelse(teamID == "LAN", "LAD", teamID)) %>%
  mutate(teamID = ifelse(teamID == "SDN", "SDP", teamID)) %>%
  mutate(teamID = ifelse(teamID == "TBA", "TBR", teamID)) %>%
  mutate(teamID = ifelse(teamID == "WAS", "WSN", teamID)) %>%
  mutate(name = ifelse(teamID == "STL", "St Louis Cardinals", name)) %>%
  mutate(name = ifelse(teamID == "LAA", "Los Angeles Angels", name)) %>%
  mutate(name = ifelse(teamID == "TBR", "Tampa Bay Rays", name)) %>%
  unique()

mlb_res <- left_join(x = mlb_res, y = teamname_lkup, by = c("home_team" = "teamID"))
```

```{r}
mlb <- right_join(x = mline, y = mlb_res, by = c("gameDate", "home_team" = "name"))
mlb %>%
  group_by(sport, season) %>%
  summarise(N = n(), numTeams = length(unique(union(visitor_team, home_team)))) %>%
  print.data.frame()

test <- mlb %>%
  group_by(sport, season, home_team) %>%
  summarise(N = n(), W = sum(home_win)) %>%
  arrange(home_team) %>%
  print.data.frame()
```

```{r}
require(mosaic)
xyplot(home_win ~ p_home, data = mlb)
lmod <- glm(home_win ~ p_home, data = mlb, family = "binomial")
exp(confint(lmod))
plotModel(lmod)
```
