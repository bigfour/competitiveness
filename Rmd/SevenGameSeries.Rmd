---
title: "SevenGameSeries"
author: "Michael Lopez"
date: "June 1, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("../config.R")
```

## Data wrangling

```{r, echo = TRUE}
library(ggbeeswarm)
library(RColorBrewer)
load(file.path(data_raw, "bigfour.rda"))
load(file.path(root, "data", "tidy_thetas.R1.rda"))
load(file.path(root, "data", "params.R1.rda"))
load(file.path(root, "data", "tidy_alphas.R1.rda"))
pteams <- read.csv("https://raw.githubusercontent.com/bigfour/competitiveness/master/data/playoff_teams.csv")
df.playoffs <- read.csv("https://docs.google.com/spreadsheets/d/1Tyhv2RU-p5VpXK_vScPbDzTuzFCAaZKVpbYXmsH22XM/pub?output=csv")

sports <- c("nba", "nhl", "mlb", "nfl")
max.week <- data.frame(sport = sports, min.week = c(22, 25, 25, 14))
last.four.weeks <- tidy_thetas %>%
  mutate(season = season + 2005) %>% 
  left_join(max.week) %>% 
  filter(week > min.week) %>% 
  group_by(name, season, sport) %>% 
  summarise(theta.max = max(theta)) %>% 
  rename(theta = theta.max)
```

```{r, echo = TRUE}
teamnames <- bigfour %>% 
  group_by(sport, home_team) %>% 
  summarise(n.games = n())
hfa <- select(params, sport, alpha)

table(df.playoffs$sport, df.playoffs$season)
tidy_alphas1 <- select(tidy_alphas, team, alpha.team.overall)
df.playoffs <- df.playoffs %>% 
  filter(! (sport == "nfl" & season == 2016))
colnames(df.playoffs)[1:2] <- c("Team1", "Team2")
df.playoffs1 <- df.playoffs %>% 
  left_join(last.four.weeks, by = c("Team1" = "name", "season" = "season", "sport" = "sport")) %>%
  rename(theta1 = theta) %>% 
  left_join(last.four.weeks, by = c("Team2" = "name", "season" = "season", "sport" = "sport")) %>% 
  rename(theta2 = theta) %>% 
  left_join(tidy_alphas1, by = c("Team1" = "team")) %>%
  rename(alpha1 = alpha.team.overall) %>% 
  left_join(tidy_alphas1, by = c("Team2" = "team")) %>%
  rename(alpha2 = alpha.team.overall)

df.playoffs2 <- df.playoffs1 %>% 
  mutate(better.first = theta1 > theta2, 
         team.b = ifelse(better.first, Team1, Team2), 
         team.w = ifelse(better.first, Team2, Team1), 
         theta.b = ifelse(better.first, theta1, theta2), 
         theta.w = ifelse(better.first, theta2, theta1), 
         alpha.b = ifelse(better.first, alpha1, alpha2), 
         alpha.w = ifelse(better.first, alpha2, alpha1)) %>%
  select(sport, season, real, team.b:alpha.w) %>%
  mutate(prob.b.home = exp(alpha.b + theta.b - theta.w)/(1 + exp(alpha.b + theta.b - theta.w)), 
         prob.b.road = 1 - exp(alpha.w + theta.w - theta.b)/(1 + exp(alpha.w + theta.w - theta.b)), 
         prob.w.home = 1 - prob.b.home, 
         prob.w.road = 1 - prob.b.road)
```


## Series level probabilities

Here's a function to define the probability of the better team defeating the worse team in a seven game series

```{r, echo = TRUE}
games.out <- function(p1, p2, series.length){
  games.win <- ceiling(series.length/2)
  i <- 1
  win.series <- dbinom(1:games.win, games.win, p1)[games.win]*1
  for (i in 1:(games.win-1)){
    prob.temp <- dbinom(1:games.win, games.win, p1)[games.win-i]*(1-pbinom((i-1), (games.win-1), p2)) 
    win.series <- win.series + prob.temp
  }
  return(win.series)
}
```


Here we use that to define probabilities in our data

```{r, echo = TRUE}
df.playoffs2 <- df.playoffs2 %>% 
  group_by(1:n()) %>% 
  mutate(better.win.7 = games.out(prob.b.home, prob.b.road, 7), 
         better.win.all = ifelse(sport == "nfl", prob.b.home, better.win.7))
```


## Graphs

```{r, echo = TRUE}
ave.prob <- df.playoffs2 %>% 
  group_by(sport) %>% 
  summarise(ave.outcome = mean(better.win.all))

base_plot <- ggplot(df.playoffs2, aes(fill = toupper(sport), color = toupper(sport))) + 
  guides(fill = FALSE, color = FALSE, alpha = FALSE) + xlab("") + 
  scale_colour_brewer(palette = "Set2") +
  scale_alpha_continuous(range = c(0.25, 1))
```

```{r beeswarm}
gsw_cle <- filter(df.playoffs2, real == 1, team.b == "Golden State Warriors" & team.w == "Cleveland Cavaliers")
base_plot + aes(x = toupper(sport)) + 
  geom_hline(data = ave.prob, aes(yintercept = ave.outcome, color = toupper(sport)), 
             linetype = 2) + 
  geom_beeswarm(aes(y = better.win.all, alpha = real)) + 
  ylab("Series win probability") + 
  # annotation for GSW-CLE
  annotate("text", x = "MLB", y = 0.9, label = "GSW-CLE") + 
  geom_text(data = gsw_cle, aes(label = season, y = better.win.all), nudge_y = 0.01) + 
  geom_curve(data = gsw_cle, aes(y = better.win.all, xend = "MLB", yend = 0.89), 
             curvature = -0.3, 
             arrow = arrow(length = unit(0.2, "cm"), ends = "first", type = "closed"))
```

```{r dots}
base_plot + aes(better.win.7, group = toupper(sport)) + 
  geom_dotplot(stackratio = 0.03) + 
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) + 
  ylab("Percent of series") + 
  labs(title = "How often does the best team win in the postseason?", subtitle = "7 game series between all playoff teams, 2005-2016") +
  scale_x_continuous(labels = scales::percent) + 
  scale_y_continuous(labels = scales::percent) + 
  facet_wrap(~toupper(sport), ncol = 1)
```

```{r density}
base_plot + aes(better.win.all, group = toupper(sport)) + 
  geom_density(color = "black") + 
  geom_vline(data = ave.prob, aes(xintercept = ave.outcome), lty = 2) + 
  ylab("Percent of series") + 
  labs(title = "How often does the best team win in the postseason?", subtitle = "All playoff teams, 2005-2016 in 1 (NFL) or 7 game series") + 
  scale_x_continuous(labels=scales::percent) + 
  #scale_y_continuous(labels=scales::percent) + 
  facet_wrap(~toupper(sport), ncol = 1)
```

```{r histogram}
base_plot + aes(better.win.all) + 
  geom_histogram(aes(y = ..density..), color = "black") + 
  ylab("Series win probability") + 
  facet_wrap(~sport, ncol = 1)
```



## Extend to longer series

```{r, echo = TRUE}
df.playoffs3 <- df.playoffs2 %>% ungroup %>% group_by(1:n()) %>% mutate(prob.3 = games.out(prob.b.home, prob.b.road, 3), 
                                            prob.7 = games.out(prob.b.home, prob.b.road, 7), 
                                            prob.11 = games.out(prob.b.home, prob.b.road, 11),
                                            prob.21 = games.out(prob.b.home, prob.b.road, 21), 
                                            prob.31 = games.out(prob.b.home, prob.b.road, 31),
                                            prob.41 = games.out(prob.b.home, prob.b.road, 41), 
                                            prob.51 = games.out(prob.b.home, prob.b.road, 51),
                                            prob.61 = games.out(prob.b.home, prob.b.road, 61), 
                                            prob.71 = games.out(prob.b.home, prob.b.road, 71),
                                            prob.81 = games.out(prob.b.home, prob.b.road, 81))

df.playoffs3 %>% 
  ungroup() %>% 
  group_by(sport) %>% 
  summarise(ave.7 = mean(prob.7), 
            ave.11 = mean(prob.11), 
            ave.21 = mean(prob.21), 
            ave.31 = mean(prob.31), 
            ave.41 = mean(prob.41), 
            ave.51 = mean(prob.51), 
            ave.61 = mean(prob.61), 
            ave.71 = mean(prob.71), 
            ave.81 = mean(prob.81))
```
